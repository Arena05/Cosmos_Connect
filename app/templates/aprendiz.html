{% extends "base.html" %}
{% block content %}
<section class="dashboard-hero">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h4 class="mb-0">Modo Aprendiz</h4>
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="switchMode">
        <label class="form-check-label" for="switchMode">Ir a Expertos</label>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="cardx p-3">
          <h5 class="mb-3">Criterios para el análisis</h5>
          <form method="POST" id="frm-analizar">
            <div class="table-responsive">
              <table class="table table-dark table-sm align-middle criteria-table">
                <thead>
                  <tr><th>Etiqueta</th><th>Magnitud</th><th>Unidades</th></tr>
                </thead>
                <tbody>
                  {% for key, label, unit in fields %}
                  <tr>
                    <td class="w-50">{{ label }}</td>
                    <td class="w-25">
                      <input name="{{ key }}_mag" type="text" class="form-control form-control-sm"
                             value="{{ (criterios[loop.index0].mag) if criterios else '' }}" placeholder="ej: 365.25">
                    </td>
                    <td class="w-25">
                      <input name="{{ key }}_unit" type="text" class="form-control form-control-sm" value="{{ unit }}">
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <button class="btn btn-cta-2" type="button" id="btn-analizar">Analizar</button>
<div id="resultado"></div>
            <a class="btn btn-outline-light ms-2" href="{{ url_for('main.menu') }}">Volver al Menú</a>
          </form>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="cardx p-3">
          <h5 class="mb-2">Modelo</h5>
          <div class="mb-2">Random Forest (fijo para Aprendiz)</div>
          <ul class="small mb-0">
            <li>n_estimators: <strong>800</strong></li>
            <li>max_depth: <strong>20</strong></li>
            <li>min_samples_split: <strong>10</strong></li>
            <li>random_state: <strong>42</strong></li>
          </ul>
        </div>
      </div>
    </div>

    {% if resultados %}
    <div class="row g-3 mt-1">
      <div class="col-lg-8">
        <div class="cardx p-3">
          <h5 class="mb-2">Criterios usados</h5>
          <div class="table-responsive">
            <table class="table table-dark table-sm align-middle">
              <thead><tr><th>Etiqueta</th><th>Magnitud</th><th>Unidades</th></tr></thead>
              <tbody>
                {% for r in resultados.criterios %}
                  {% if r.mag %}
                  <tr><td>{{ r.label }}</td><td>{{ r.mag }}</td><td>{{ r.unit }}</td></tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="cardx p-3">
          <h5 class="mb-2">Resultado de Predicción</h5>
          <div class="mb-1 small text-light-70">{{ resultados.modelo }}</div>
          <div class="display-6">{{ (resultados.pred.prob * 100)|round(1) }}%</div>
          <div class="mb-2">{{ resultados.pred.clase }}</div>

          <h6 class="mt-3">Parámetros</h6>
          <ul class="small mb-0">
            {% for k,v in resultados.params.items() %}
              <li>{{ k }}: <strong>{{ v }}</strong></li>
            {% endfor %}
          </ul>

          <form action="{{ url_for('main.guardar_experimento') }}" method="post" class="mt-2">
            <input type="hidden" name="model_name" value="{{ resultados.modelo }}">
            <input type="hidden" name="params_json" value='{{ resultados.params|tojson }}'>
            <input type="hidden" name="criteria_json" value='{{ resultados.criterios|tojson }}'>
            <input type="hidden" name="prob" value="{{ resultados.pred.prob }}">
            <input type="hidden" name="predicted_class" value="{{ resultados.pred.clase }}">
            <button type="submit" class="btn btn-primary w-100">Guardar experimento</button>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const sw = document.getElementById('switchMode');
  if (!sw) return;
  sw.checked = false;
  sw.addEventListener('change', function(e){
    e.preventDefault();
    window.location.href = "{{ url_for('main.expertos') }}";
  });
});
</script>

<script>
(function(){
  const form = document.getElementById('frm-analizar');
  const btn = document.getElementById('btn-analizar');
  const out = document.getElementById('resultado');
  if (!form || !btn || !out) return;

  // Lista de keys desde el template (evita desincronizar nombres)
  const FIELDS = [
    {% for key, label, unit in fields %}"{{ key }}",{% endfor %}
  ];

  btn.addEventListener('click', async function(){
    const fd = new FormData(form);
    const criterios = FIELDS.map(k => ({
      key: k,
      label: k,
      mag: (fd.get(k + "_mag") || "").trim(),
      unit: (fd.get(k + "_unit") || "").trim(),
    }));
    try {
      const res = await fetch("{{ url_for('main.api_analizar') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ modelo: "rf", criterios })
      });
      const data = await res.json();
      if (data.ok) {
        out.innerHTML = data.html;
      } else {
        out.innerHTML = `<div class="alert alert-danger">${data.error || 'Error en el análisis'}</div>`;
      }
    } catch (err) {
      out.innerHTML = `<div class="alert alert-danger">No se pudo conectar con el servidor.</div>`;
    }
  });
})();
</script>

{% endblock %}
