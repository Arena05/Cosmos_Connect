{% extends "base.html" %}
{% block title %}Exoplanet 3D{% endblock %}
{% block content %}
<div class="card" style="padding:0; border:none;">
  <div class="hud" style="position:absolute; top:12px; left:12px; background:rgba(20,24,42,.6); padding:8px 12px; border-radius:12px; backdrop-filter: blur(6px); z-index:2;">
    <span style="display:inline-block; margin-right:8px; padding:2px 8px; border-radius:999px; border:1px solid #2b355b;">Drag=rotate · Wheel=zoom</span>
    <span id="predChip" style="display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #2b355b;"></span>
  </div>
  <div id="viewer3d" style="width:100%; height:80vh;"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.161.0/examples/js/controls/OrbitControls.js"></script>
<script>
  const DATA   = {{ system_json|tojson }};
  const STAR   = DATA.star || {};
  const PLANET = DATA.planet || {};
  const SCORE  = DATA.score || {};
  const DER    = DATA.derived || {};

  // YOUR variables (do not rename)
  const st_rad    = Number(STAR.st_rad  || 1.0);      // R☉
  const pl_orbper = Number(PLANET.pl_orbper || 10.0); // days
  const pl_rade   = Number(PLANET.pl_rade   || 1.2);  // R⊕
  const pl_eqt    = PLANET.pl_eqt != null ? Number(PLANET.pl_eqt) : null;

  const a_au = (DER.semi_major_au != null)
      ? Number(DER.semi_major_au)
      : (()=>{ const Pyr=pl_orbper/365.25; return Math.cbrt(Pyr*Pyr*1.0); })();

  // Scene
  const SCALE_AU=50, SCALE_R_SUN=8, SCALE_R_EARTH=0.4, TIME_SCALE=0.25;
  const container=document.getElementById('viewer3d');
  const scene=new THREE.Scene(); scene.background=new THREE.Color(0x0b0d16);
  const camera=new THREE.PerspectiveCamera(60, container.clientWidth/container.clientHeight, 0.1, 5000); camera.position.set(0,80,160);
  const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth, container.clientHeight); container.appendChild(renderer.domElement);
  const controls=new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true;

  scene.add(new THREE.AmbientLight(0x404040, 0.5));
  const starLight=new THREE.PointLight(0xffffff, 2.0, 0, 2); scene.add(starLight);

  // Star
  const starR=Math.max(0.3, st_rad*SCALE_R_SUN);
  const star=new THREE.Mesh(new THREE.SphereGeometry(starR,48,48), new THREE.MeshBasicMaterial({color:0xfff2a6}));
  scene.add(star); starLight.position.copy(star.position);

  // Simple orbit
  const a=a_au*SCALE_AU, N=256, pts=[];
  for(let i=0;i<=N;i++){ const t=(i/N)*Math.PI*2; pts.push(new THREE.Vector3(a*Math.cos(t),0,a*Math.sin(t))); }
  scene.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({opacity:0.6, transparent:true})));

  // Color by equilibrium temp
  function colorFromTempK(T){ if(T==null)return 0x7aa2f7; if(T<2500)return 0xff7b6b; if(T<4000)return 0xffbb88; if(T<6000)return 0xffffff; return 0xaad0ff; }

  // Planet
  const planetR=Math.max(0.2, pl_rade*SCALE_R_EARTH);
  const planet=new THREE.Mesh(new THREE.SphereGeometry(planetR,32,32), new THREE.MeshStandardMaterial({color:colorFromTempK(pl_eqt), roughness:0.6, metalness:0.0}));
  scene.add(planet); planet.position.set(a,0,0);

  // HUD
  function bestLabel(s){ const e=Object.entries(s||{}); if(!e.length)return "No score"; e.sort((a,b)=>b[1]-a[1]); const [l,v]=e[0]; return `${l}: ${(v*100).toFixed(1)}%`; }
  document.getElementById("predChip").textContent = bestLabel(SCORE);
  document.title = `${PLANET.pl_name || "Planet"} · ${bestLabel(SCORE)} · Exoplanet 3D`;

  // Animation
  let theta=0, last=performance.now();
  function animate(){
    requestAnimationFrame(animate);
    const now=performance.now(), dt=(now-last)/1000; last=now;
    const omega=(2*Math.PI)/(pl_orbper||10.0); theta += omega*dt*TIME_SCALE;
    planet.position.x=a*Math.cos(theta); planet.position.z=a*Math.sin(theta);
    planet.rotation.y += 0.01;
    controls.update(); renderer.render(scene,camera);
  }
  animate();

  window.addEventListener('resize', ()=>{ camera.aspect=container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
</script>
{% endblock %}
